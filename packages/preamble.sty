\NeedsTeXFormat{LaTeX2e}
\RequirePackage{luatex85}

% ╒════════════════╕
% │ LaTeX PACKAGES │
% ╘════════════════╛
\usepackage{datetime2}
\usepackage{emptypage}
\usepackage{fancyhdr}
\usepackage{fontspec}
\usepackage{graphicx}
\usepackage{ifdraft}
\usepackage{import}
\usepackage{setspace}
\usepackage{tabularx}
\usepackage{titlesec}
\usepackage{titling}
\usepackage{xparse}

\usepackage[english]{babel}
\usepackage[utf8]{luainputenc}
\usepackage[autostyle]{csquotes}
\usepackage[T1]{fontenc}
\usepackage[hidelinks,final]{hyperref}
\usepackage[final]{microtype}
\usepackage[dvipsnames]{xcolor}

% ╒═══════════╕
% │ PDF SETUP │
% ╘═══════════╛
\hypersetup{
  unicode,
  pdflang={en-US},
  pdfpagelayout={TwoPageRight},
  pdfborder={0 0 0},
  hidelinks,
  colorlinks,
  linkcolor={black},
  urlcolor={blue}
}

\AtBeginDocument{
  \hypersetup{
    pdftitle={\thetitle},
    pdfauthor={\theauthor}
  }
}

% ╒═════════════════╕
% │ PAGE DIMENSIONS │
% ╘═════════════════╛
% General dimensions
\AtBeginDocument{
  \setlength{\pdfpagewidth}{11.8cm}
  \setlength{\pdfpageheight}{17.7cm}
}

\renewcommand{\baselinestretch}{1.12}
\setlength{\topmargin}{-1.8cm}
\setlength{\textheight}{15cm}
\setlength{\oddsidemargin}{-1.0cm}
\setlength{\evensidemargin}{-1.5cm}
\setlength{\textwidth}{9.25cm}
\setlength{\parindent}{15pt}
\setlength{\parskip}{7pt}
\setlength{\footnotesep}{10pt}
\setlength{\skip\footins}{12pt}
\raggedbottom

% Vertically centered content
\newenvironment{vcenter*}{
  \vspace*{\stretch{1}}
}{
  \vspace*{\stretch{1}}
}

% Page centered content
\newenvironment{pcenter*}{
  \vspace*{\stretch{1}}\begin{center}
}{
  \vspace*{\stretch{1}}\end{center}
}

% ╒═════════════════╕
% │ HEADERS/FOOTERS │
% ╘═════════════════╛
% Default page style
\pagestyle{fancy}
\fancyhf{}
\fancyfoot{}

% Headers 
\fancyhead[RO]{\small\textit{\leftmark}}
\fancyhead[LE]{\small\textit{\thetitle}}
\renewcommand{\headrulewidth}{0pt}
\setlength{\headsep}{0.25cm}

% Footers
\fancyfoot[LE, RO]{\oldstylenums\thepage}
\renewcommand\footnoterule{\rule{\linewidth}{0pt}}
\setlength{\footskip}{0.5cm}

% Chapter name lookup
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}

% Widow/Orphan lines
\widowpenalty10000
\clubpenalty10000

% ╒═══════╕
% │ FONTS │
% ╘═══════╛
\setmainfont{Cambria}
\urlstyle{same}

\newcommand{\ipa}[1]{#1}

% ╒══════════╕
% │ CHAPTERS │
% ╘══════════╛
% Title format for chapters
\titleformat{\chapter}[display]
  {\Large}
  {\filright\MakeUppercase{}}
  {0cm}
  {\thispagestyle{plain}\vspace{1ex}\filleft}
  [\vspace{0cm}]

% Title format for sections
\titleformat{\section}[display]
  {\bfseries\large\itshape}
  {\filright\MakeUppercase{}}
  {-0.5cm}
  {\vspace{0cm}\filright}
  [\vspace{0cm}]

% Title format for subsections
\titleformat{\subsection}[display]
  {\bfseries\itshape}
  {\filright\MakeUppercase{}}
  {-0.5cm}
  {\vspace{0cm}\filright}
  [\vspace{0cm}]

% Formatting on chapter pages
\fancypagestyle{plain}{
  \fancyhead{}
  \fancyfoot[LE, RO]{\oldstylenums\thepage}
  \renewcommand\footnoterule{\rule{\linewidth}{0pt}}
  \setlength{\footskip}{0.5cm}
}

% Chapter first page style
\fancypagestyle{empty}{
  \fancyhead{}
  \fancyfoot{}
  \renewcommand\footnoterule{\rule{\linewidth}{0pt}}
  \setlength{\footskip}{0.5cm}
}

% Completely empty page style
\fancypagestyle{emptycomplete}{
  \fancyhead{}
  \fancyfoot{}
  \renewcommand\footnoterule{\rule{\linewidth}{0pt}}
  \setlength{\footskip}{0.5cm}
}

% Environment for explicit fonts
\newenvironment{myfont}{\fontfamily{ppl}\selectfont}{\par}

% ╒══════════════════╕
% │ WORK IN PROGRESS │
% ╘══════════════════╛
% TODO markings
\newcommand{\todo}[1]{\ifdraft{
    \noindent\textit{\color{Gray}\%\color{Cerulean}TODO: #1\color{white}}
  }
  {}
}

\newcommand{\draftref}[2][]{\ifdraft{\hyperref[#1]{#2}}{#2}}

\newcommand{\linedbullet}{\hspace{-2.75pt}$\bullet$ \hspace{5pt}}

\newcommand{\chref}[1][]{\hyperref[ch:#1]{>#1:}}

\newcommand{\newname}[3][]{\expandafter\newcommand{#2}{\texorpdfstring{\draftref[#1]{#3}}{#3}}}


\ExplSyntaxOn
\NewDocumentCommand{\captureshell}{som}
 {
  \sdaau_captureshell:Ne \l__sdaau_captureshell_out_tl { #3 }
  \IfBooleanT { #1 }
   {
    \tl_set:Nx \l__sdaau_captureshell_out_tl
     { \tl_to_str:N \l__sdaau_captureshell_out_tl }
   }
  \IfNoValueTF { #2 }
   {
    \tl_use:N \l__sdaau_captureshell_out_tl
   }
   {
    \tl_set_eq:NN #2 \l__sdaau_captureshell_out_tl
   }
 }

\tl_new:N \l__sdaau_captureshell_out_tl

\cs_new_protected:Nn \sdaau_captureshell:Nn
 {
  \sys_get_shell:nnN { #2 } { } #1
  \tl_trim_spaces:N #1 % remove leading and trailing spaces
 }
\cs_generate_variant:Nn \sdaau_captureshell:Nn { Ne }
\ExplSyntaxOff

\newcommand\twodigits[1]{%
   \ifnum#1<10 0#1\else #1\fi
}

\newcommand{\importnumbered}[2]{
  \newcount\chapternum
    \chapternum=1
    \loop
        \expandafter\import{#1}{\twodigits{\the\chapternum}.tex}
        \advance \chapternum 1
    \ifnum \chapternum<#2
    \repeat
}

\makeatletter
    \edef\gitcommitdate{\@@input|"git show --no-patch --format=\@percentchar cI"}
\makeatother
